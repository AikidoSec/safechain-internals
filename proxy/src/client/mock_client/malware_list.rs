use std::convert::Infallible;

use rama::{
    Service,
    http::{
        Request, Response,
        service::web::{
            Router,
            response::{IntoResponse, Json},
        },
    },
};

use crate::firewall::malware_list::{ListDataEntry, PackageVersion, Reason};

pub(super) fn web_svc() -> impl Service<Request, Output = Response, Error = Infallible> {
    Router::new()
        .with_get("malware_vscode.json", malware_vscode)
        .with_get("malware_predictions.json", malware_npm)
        .with_get("malware_pypi.json", malware_pypi)
        .with_get("malware_chrome.json", malware_chrome)
}

async fn malware_vscode() -> impl IntoResponse {
    Json([ListDataEntry {
        package_name: "pythoner.pythontheme".to_owned(),
        version: PackageVersion::Semver(semver::Version::new(2, 7, 5)),
        reason: Reason::Malware,
    }])
}

async fn malware_npm() -> impl IntoResponse {
    Json([ListDataEntry {
        package_name: "safe-chain-test".to_owned(),
        version: PackageVersion::Semver(semver::Version {
            major: 0,
            minor: 0,
            patch: 1,
            pre: semver::Prerelease::new("security").unwrap(),
            build: Default::default(),
        }),
        reason: Reason::Malware,
    }])
}

async fn malware_pypi() -> impl IntoResponse {
    Json([ListDataEntry {
        package_name: "safe-chain-pi-test".to_owned(),
        version: PackageVersion::Semver(semver::Version::new(0, 1, 0)),
        reason: Reason::Malware,
    }])
}

async fn malware_chrome() -> impl IntoResponse {
    // Chrome malware list uses format: "Title - Chrome Web Store@<extension-id>"
    Json([ListDataEntry {
        package_name: "Malicious Extension - Chrome Web Store@lajondecmobodlejlcjllhojikagldgd"
            .to_owned(),
        version: PackageVersion::Semver(semver::Version::new(1, 0, 0)),
        reason: Reason::Malware,
    }])
}
