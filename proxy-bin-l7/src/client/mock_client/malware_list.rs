use std::convert::Infallible;

use rama::{
    Service,
    http::{
        Request, Response,
        service::web::{
            Router,
            response::{IntoResponse, Json},
        },
    },
};

use safechain_proxy_lib::package::{
    malware_list::{ListDataEntry, Reason},
    version::{PackageVersion, PragmaticSemver},
};

pub(super) fn web_svc() -> impl Service<Request, Output = Response, Error = Infallible> {
    Router::new()
        .with_get("malware_vscode.json", malware_vscode)
        .with_get("malware_nuget.json", malware_nuget)
        .with_get("malware_predictions.json", malware_npm)
        .with_get("malware_pypi.json", malware_pypi)
        .with_get("malware_chrome.json", malware_chrome)
}

async fn malware_vscode() -> impl IntoResponse {
    Json([ListDataEntry {
        package_name: "pythoner.pythontheme".to_owned(),
        version: PackageVersion::Semver(PragmaticSemver::new_semver(2, 7, 5)),
        reason: Reason::Malware,
    }])
}

async fn malware_nuget() -> impl IntoResponse {
    Json([ListDataEntry {
        package_name: "SafeChainTest".to_owned(),
        version: PackageVersion::Semver(PragmaticSemver::new_semver(0, 0, 1).with_pre("security")),
        reason: Reason::Malware,
    }])
}

async fn malware_npm() -> impl IntoResponse {
    Json([
        ListDataEntry {
            package_name: "safe-chain-test".to_owned(),
            version: PackageVersion::Semver(
                PragmaticSemver::new_semver(0, 0, 1).with_pre("security"),
            ),
            reason: Reason::Malware,
        },
        ListDataEntry {
            package_name: "safe-chain-test".to_owned(),
            version: PackageVersion::Semver(
                PragmaticSemver::new_semver(0, 0, 2).with_pre("security"),
            ),
            reason: Reason::Malware,
        },
    ])
}

async fn malware_pypi() -> impl IntoResponse {
    Json([ListDataEntry {
        package_name: "safe-chain-pi-test".to_owned(),
        version: PackageVersion::Semver(PragmaticSemver::new_semver(0, 1, 0)),
        reason: Reason::Malware,
    }])
}

async fn malware_chrome() -> impl IntoResponse {
    // Chrome malware list uses format: "Title - Chrome Web Store@<extension-id>"
    Json([
        ListDataEntry {
            package_name: "Malicious Extension - Chrome Web Store@lajondecmobodlejlcjllhojikagldgd"
                .to_owned(),
            version: PackageVersion::Unknown("1.0.0.0".into()),
            reason: Reason::Malware,
        },
        ListDataEntry {
            package_name: "Into the Black Hole - Chrome Web Store@faeadnfmdfamenfhaipofoffijhlnkif"
                .to_owned(),
            version: PackageVersion::Unknown("6.45.0.0".into()),
            reason: Reason::Malware,
        },
        ListDataEntry {
            package_name:
                "Extension with only 3 digits - Chrome Web Store@faeadndfretgofoffijhlnkif"
                    .to_owned(),
            version: PackageVersion::Unknown("1225.100000.0".into()),
            reason: Reason::Malware,
        },
        ListDataEntry {
            package_name:
                "Extension with 2-part version - Chrome Web Store@feeadnfmdfahesfhtipdfoffijhlnkif"
                    .to_owned(),
            version: PackageVersion::Unknown("14.1270".into()),
            reason: Reason::Malware,
        },
    ])
}
