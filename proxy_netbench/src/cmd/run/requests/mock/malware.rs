use std::{sync::LazyLock, time::Duration};

use rama::{
    Layer as _, Service as _,
    error::OpaqueError,
    http::{
        Body, Request, Response, Uri,
        client::EasyHttpWebClient,
        layer::{
            decompression::DecompressionLayer,
            map_request_body::MapRequestBodyLayer,
            map_response_body::MapResponseBodyLayer,
            retry::{ManagedPolicy, RetryLayer},
            timeout::TimeoutLayer,
        },
    },
    layer::MapErrLayer,
    service::BoxService,
    utils::{backoff::ExponentialBackoff, rng::HasherRng},
};

use safechain_proxy_lib::{
    firewall::malware_list::{self},
    storage,
};

pub async fn download_malware_list_for_uri(
    sync_storage: storage::SyncCompactDataStorage,
    uri: &'static str,
) -> Result<Vec<malware_list::ListDataEntry>, OpaqueError> {
    let client = shared_download_client();
    malware_list::RemoteMalwareList::download_data_entry_list(
        Uri::from_static(uri),
        sync_storage,
        client,
    )
    .await
}

fn shared_download_client() -> BoxService<Request, Response, OpaqueError> {
    static CLIENT: LazyLock<BoxService<Request, Response, OpaqueError>> = LazyLock::new(|| {
        let inner_https_client = EasyHttpWebClient::default();
        (
            MapResponseBodyLayer::new(Body::new),
            DecompressionLayer::new(),
            MapErrLayer::new(OpaqueError::from_std),
            TimeoutLayer::new(Duration::from_secs(60)),
            RetryLayer::new(
                ManagedPolicy::default().with_backoff(
                    ExponentialBackoff::new(
                        Duration::from_millis(100),
                        Duration::from_secs(30),
                        0.01,
                        HasherRng::default,
                    )
                    .expect("create exponential backoff impl"),
                ),
            ),
            MapRequestBodyLayer::new(Body::new),
        )
            .into_layer(inner_https_client)
            .boxed()
    });

    CLIENT.clone()
}
