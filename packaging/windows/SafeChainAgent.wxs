<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="SafeChain Agent"
           Manufacturer="Aikido Security BV"
           Version="$(var.Version)"
           ProductCode="5d8fd7e2-55b5-4fc4-82b2-de8ee83f0061"
           UpgradeCode="adb9d7b9-de00-4953-af0e-9c1e9ec15c81"
           Scope="perMachine">

    <MajorUpgrade DowngradeErrorMessage="A newer version of SafeChain Agent is already installed." />
    
    <Media Id="1" Cabinet="SafeChainAgent.cab" EmbedCab="yes" />

    <!-- Define installation directory structure -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLDIR" Name="AikidoSecurity">
        <Directory Id="AGENTDIR" Name="SafeChainAgent">
          <Directory Id="BINDIR" Name="bin" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- ProgramData directory for cleanup on uninstall -->
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="APPDATAAIKIDO" Name="AikidoSecurity">
        <Directory Id="APPDATAAGENT" Name="SafeChainAgent">
          <Directory Id="APPDATALOGSDIR" Name="logs" />
          <Directory Id="APPDATARUNDIR" Name="run" />
          <Directory Id="APPDATABINDIR" Name="bin" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- Main feature -->
    <Feature Id="MainFeature" Title="Aikido Agent" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="PathComponent" />
      <ComponentRef Id="CleanupProgramData" />
    </Feature>

    <!-- Components -->
    <ComponentGroup Id="ProductComponents" Directory="BINDIR">
      <Component Id="AikidoAgentExe" Guid="3a2f5c8e-e57f-4ce4-ab7f-fa89e94c48cb">
        <File Id="AikidoAgentExeFile" Source="$(var.BinDir)\SafeChainAgent.exe" KeyPath="yes" />
        <ServiceInstall Id="SafeChainAgentService"
                        Name="SafeChainAgent"
                        DisplayName="SafeChain Agent"
                        Description="Aikido Security SafeChain Agent - monitors and secures the software supply chain"
                        Start="auto"
                        Type="ownProcess"
                        ErrorControl="normal"
                        Account="LocalSystem" />
        <ServiceControl Id="SafeChainAgentServiceControl"
                        Name="SafeChainAgent"
                        Start="install"
                        Stop="both"
                        Remove="uninstall"
                        Wait="yes" />
      </Component>
      <Component Id="SafeChainProxyExe" Guid="8a745110-05f7-4bb8-8013-5fca733409ef">
        <File Id="SafeChainProxyExeFile" Source="$(var.BinDir)\SafeChainProxy.exe" KeyPath="yes" />
      </Component>
      <Component Id="VCRuntime140" Guid="d4a2e7f8-9b3c-4e5d-a6f7-8c9d0e1f2a3b">
        <File Id="VCRuntime140Dll" Source="$(var.BinDir)\vcruntime140.dll" KeyPath="yes" />
      </Component>
      <Component Id="VCRuntime140_1" Guid="e5b3f8a9-0c4d-5f6e-b7a8-9d0e1f2a3b4c">
        <File Id="VCRuntime140_1Dll" Source="$(var.BinDir)\vcruntime140_1.dll" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Add to PATH -->
    <DirectoryRef Id="BINDIR">
      <Component Id="PathComponent" Guid="5809b6b6-57a0-4c2a-9d55-7b274ceb916a">
        <Environment Id="PATH" Name="PATH" Value="[BINDIR]" Permanent="no" Part="last" Action="set" System="yes" />
      </Component>
    </DirectoryRef>

    <!-- Cleanup ProgramData on uninstall -->
    <DirectoryRef Id="APPDATAAGENT">
      <Component Id="CleanupProgramData" Guid="c7e8f9a1-2b3c-4d5e-6f7a-8b9c0d1e2f3a">
        <RemoveFile Id="RemoveLogsFiles" Directory="APPDATALOGSDIR" Name="*" On="uninstall" />
        <RemoveFile Id="RemoveRunFiles" Directory="APPDATARUNDIR" Name="*" On="uninstall" />
        <RemoveFile Id="RemoveBinFiles" Directory="APPDATABINDIR" Name="*" On="uninstall" />
        <RemoveFile Id="RemoveAgentFiles" Name="*" On="uninstall" />
        <RemoveFolder Id="RemoveLogsDir" Directory="APPDATALOGSDIR" On="uninstall" />
        <RemoveFolder Id="RemoveRunDir" Directory="APPDATARUNDIR" On="uninstall" />
        <RemoveFolder Id="RemoveBinDir" Directory="APPDATABINDIR" On="uninstall" />
        <RemoveFolder Id="RemoveAgentDir" Directory="APPDATAAGENT" On="uninstall" />
        <RemoveFolder Id="RemoveAikidoDir" Directory="APPDATAAIKIDO" On="uninstall" />
      </Component>
    </DirectoryRef>

    <!-- UI with license -->
    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)\packaging\windows\license.rtf" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
    <ui:WixUI Id="WixUI_InstallDir" />

  </Package>
</Wix>

