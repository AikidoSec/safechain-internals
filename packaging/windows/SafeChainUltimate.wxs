<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <Package Name="SafeChain Ultimate"
           Manufacturer="Aikido Security BV"
           Version="$(var.Version)"
           ProductCode="*"
           UpgradeCode="adb9d7b9-de00-4953-af0e-9c1e9ec15c81"
           Scope="perMachine">

    <Icon Id="SafeChainIcon.ico" SourceFile="$(var.ProjectDir)\packaging\shared\resources\SafeChain.ico" />
    <Property Id="ARPPRODUCTICON" Value="SafeChainIcon.ico" />
    <Property Id="AIKIDO_TOKEN" Secure="yes" />

    <MajorUpgrade Schedule="afterInstallValidate" DowngradeErrorMessage="A newer version of SafeChain Ultimate is already installed." AllowSameVersionUpgrades="yes" />
    
    <Media Id="1" Cabinet="SafeChainUltimate.cab" EmbedCab="yes" />

    <!-- Define installation directory structure -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLDIR" Name="AikidoSecurity">
        <Directory Id="AGENTDIR" Name="SafeChainUltimate">
          <Directory Id="BINDIR" Name="bin" />
          <Directory Id="SCRIPTSDIR" Name="scripts" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- ProgramData directory for cleanup on uninstall -->
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="APPDATAAIKIDO" Name="AikidoSecurity">
        <Directory Id="APPDATAAGENT" Name="SafeChainUltimate">
          <Directory Id="APPDATALOGSDIR" Name="logs" />
          <Directory Id="APPDATARUNDIR" Name="run" />
          <Directory Id="APPDATABINDIR" Name="bin" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- Main feature -->
    <Feature Id="MainFeature" Title="SafeChain Ultimate" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="PathComponent" />
      <ComponentRef Id="CleanupProgramData" />
      <ComponentRef Id="StoreTokenScript" />
    </Feature>

    <!-- Components -->
    <ComponentGroup Id="ProductComponents" Directory="BINDIR">
      <Component Id="AikidoAgentExe" Guid="3a2f5c8e-e57f-4ce4-ab7f-fa89e94c48cb">
        <File Id="AikidoAgentExeFile" Source="$(var.BinDir)\SafeChainUltimate.exe" KeyPath="yes" />
        <ServiceInstall Id="SafeChainUltimateService"
                        Name="SafeChainUltimate"
                        DisplayName="SafeChain Ultimate"
                        Description="Aikido Security SafeChain Ultimate - monitors and secures the software supply chain"
                        Start="auto"
                        Type="ownProcess"
                        ErrorControl="normal"
                        Account="LocalSystem" />
        <util:ServiceConfig
                        ServiceName="SafeChainUltimate"
                        FirstFailureActionType="restart"
                        SecondFailureActionType="restart"
                        ThirdFailureActionType="restart"
                        RestartServiceDelayInSeconds="60"
                        ResetPeriodInDays="1" />
        <ServiceControl Id="SafeChainUltimateServiceControl"
                        Name="SafeChainUltimate"
                        Start="install"
                        Stop="both"
                        Remove="uninstall"
                        Wait="yes" />
      </Component>
      <Component Id="SafeChainUltimateUIExe" Guid="ceafd8b2-da4d-4c92-ace7-8736cdd67162">
        <File Id="SafeChainUltimateUIExe" Source="$(var.BinDir)\SafeChainUltimateUI.exe" KeyPath="yes" />
      </Component>
      <Component Id="SafeChainProxyExe" Guid="8a745110-05f7-4bb8-8013-5fca733409ef">
        <File Id="SafeChainProxyExeFile" Source="$(var.BinDir)\SafeChainProxy.exe" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <DirectoryRef Id="SCRIPTSDIR">
      <Component Id="StoreTokenScript" Guid="d1e2f3a4-5b6c-7d8e-9f0a-1b2c3d4e5f6a">
        <File Id="StoreTokenPs1" Source="$(var.ProjectDir)\packaging\windows\scripts\StoreToken.ps1" KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Add to PATH -->
    <DirectoryRef Id="BINDIR">
      <Component Id="PathComponent" Guid="5809b6b6-57a0-4c2a-9d55-7b274ceb916a">
        <Environment Id="PATH" Name="PATH" Value="[BINDIR]" Permanent="no" Part="last" Action="set" System="yes" />
      </Component>
    </DirectoryRef>

    <!-- Custom action to run teardown on uninstall (runs elevated before files are removed) -->
    <CustomAction Id="RunTeardown"
                  FileRef="AikidoAgentExeFile"
                  ExeCommand="--teardown"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <SetProperty Id="WriteAikidoToken" Before="WriteAikidoToken" Sequence="execute"
                 Condition="AIKIDO_TOKEN"
                 Value="&quot;[WindowsFolder]System32\WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -File &quot;[SCRIPTSDIR]StoreToken.ps1&quot; -Token &quot;[AIKIDO_TOKEN]&quot;" />
    <CustomAction Id="WriteAikidoToken"
                  DllEntry="WixQuietExec64"
                  BinaryRef="Wix4UtilCA_X86"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <InstallExecuteSequence>
      <Custom Action="RunTeardown" Before="RemoveFiles" Condition="(REMOVE~=&quot;ALL&quot;)" />
      <Custom Action="WriteAikidoToken" Before="StartServices" Condition="AIKIDO_TOKEN" />
    </InstallExecuteSequence>

    <!-- Cleanup ProgramData on uninstall -->
    <DirectoryRef Id="APPDATAAGENT">
      <Component Id="CleanupProgramData" Guid="c7e8f9a1-2b3c-4d5e-6f7a-8b9c0d1e2f3a">
        <RemoveFile Id="RemoveLogsFiles" Directory="APPDATALOGSDIR" Name="*" On="uninstall" />
        <RemoveFile Id="RemoveRunFiles" Directory="APPDATARUNDIR" Name="*" On="uninstall" />
        <RemoveFile Id="RemoveBinFiles" Directory="APPDATABINDIR" Name="*" On="uninstall" />
        <RemoveFile Id="RemoveAgentFiles" Name="*" On="uninstall" />
        <RemoveFolder Id="RemoveLogsDir" Directory="APPDATALOGSDIR" On="uninstall" />
        <RemoveFolder Id="RemoveRunDir" Directory="APPDATARUNDIR" On="uninstall" />
        <RemoveFolder Id="RemoveBinDir" Directory="APPDATABINDIR" On="uninstall" />
        <RemoveFolder Id="RemoveAgentDir" Directory="APPDATAAGENT" On="uninstall" />
        <RemoveFolder Id="RemoveAikidoDir" Directory="APPDATAAIKIDO" On="uninstall" />
      </Component>
    </DirectoryRef>

    <!-- UI with license and token dialog -->
    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)\packaging\windows\license.rtf" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
    <ui:WixUI Id="WixUI_InstallDir" />

    <UI>
      <Dialog Id="AikidoTokenDlg" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="WixUI_Bmp_Banner" />
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />

        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="{\WixUI_Font_Title}Aikido Token" />
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="Enter your Aikido token to activate the agent." />

        <Control Id="TokenLabel" Type="Text" X="20" Y="60" Width="330" Height="40" NoPrefix="yes" Text="Paste your Aikido token below. This step is optional â€” you can configure the token later." />
        <Control Id="TokenEdit" Type="Edit" X="20" Y="110" Width="330" Height="18" Property="AIKIDO_TOKEN" />

        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="!(loc.WixUIBack)" />
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="!(loc.WixUINext)" />
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="!(loc.WixUICancel)">
          <Publish Event="SpawnDialog" Value="CancelDlg" />
        </Control>
      </Dialog>

      <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="AikidoTokenDlg" Order="5">LicenseAccepted = "1"</Publish>
      <Publish Dialog="AikidoTokenDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
      <Publish Dialog="AikidoTokenDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="AikidoTokenDlg" Order="5">1</Publish>
    </UI>

  </Package>
</Wix>

