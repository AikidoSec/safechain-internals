#!/bin/bash

set -e

echo "SafeChain Ultimate Installer - Post-installation"

INSTALL_DIR="/Library/Application Support/AikidoSecurity/SafeChainUltimate"
LOGS_DIR="/Library/Logs/AikidoSecurity/SafeChainUltimate"
RUN_DIR="$INSTALL_DIR/run"
LAUNCHDAEMON_PLIST="/Library/LaunchDaemons/com.aikidosecurity.safechainultimate.plist"

# Ensure logs directory exists and has proper permissions
echo "Setting up logs directory..."
mkdir -p "$LOGS_DIR"
mkdir -p "$RUN_DIR"
chmod 755 "$LOGS_DIR"

# Set proper permissions on binaries
echo "Setting permissions on binaries..."
chmod 755 "$INSTALL_DIR/bin/safechain-ultimate"
chmod 755 "$INSTALL_DIR/bin/safechain-ultimate-ui"
chmod 755 "$INSTALL_DIR/bin/safechain-l7-proxy"

# Set proper ownership (root:wheel for system daemon)
echo "Setting ownership..."
chown -R root:wheel "$INSTALL_DIR"
chown -R root:wheel "$LOGS_DIR"
chown -R root:wheel "$RUN_DIR"

AIKIDO_TOKEN=""
TOKEN_STAGING_FILE="/tmp/aikido_endpoint_token.txt"

if [ -f "$TOKEN_STAGING_FILE" ]; then
    AIKIDO_TOKEN="$(cat "$TOKEN_STAGING_FILE" | tr -d '[:space:]')"
    rm -f "$TOKEN_STAGING_FILE"
fi

if [ -z "$AIKIDO_TOKEN" ]; then
    echo "Token file not found or empty, prompting user..."
    AIKIDO_TOKEN=$(osascript <<'APPLESCRIPT' 2>/dev/null
set dialogResult to display dialog "Enter your Token to activate Aikido Endpoint Protection." & return & return & "You can find this token in your Aikido Security dashboard." with title "SafeChain Ultimate â€” Token Setup" default answer "" buttons {"Skip", "OK"} default button "OK" with icon caution
if button returned of dialogResult is "OK" then
    return text returned of dialogResult
else
    return ""
end if
APPLESCRIPT
    ) || true
    AIKIDO_TOKEN="$(echo "$AIKIDO_TOKEN" | tr -d '[:space:]')"

    if [ -z "$AIKIDO_TOKEN" ]; then
        echo "No token provided. You can configure it later by writing your token to:"
        echo "  $RUN_DIR/config.json"
        echo "  Format: {\"token\":\"YOUR_TOKEN\"}"
    fi
fi

if [ -n "$AIKIDO_TOKEN" ]; then
    echo "Storing Aikido token..."
    CONFIG_FILE="$RUN_DIR/config.json"
    echo '{"token":"'"$AIKIDO_TOKEN"'"}' > "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"
    chown root:wheel "$CONFIG_FILE"
fi

# Load and start the LaunchDaemon
if [ -f "$LAUNCHDAEMON_PLIST" ]; then
    echo "Loading LaunchDaemon..."
    launchctl bootstrap system "$LAUNCHDAEMON_PLIST" 2>/dev/null || {
        # Fallback to launchctl load (old way of starting the daemon on older macOS versions)
        echo "LaunchDaemon bootstrap failed, trying load..."
        launchctl load "$LAUNCHDAEMON_PLIST" || true
    }
    echo "SafeChain Ultimate daemon installed and started"
else
    echo "Warning: LaunchDaemon plist not found at $LAUNCHDAEMON_PLIST"
fi

echo "Post-installation completed"
echo ""
echo "SafeChain Ultimate has been installed successfully!"
echo "  Binaries: $INSTALL_DIR/bin"
echo "  Logs: $LOGS_DIR"
echo ""
echo "The agent is now running as a system daemon."

exit 0
