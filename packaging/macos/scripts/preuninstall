#!/bin/bash

set -e

echo "SafeChain Ultimate Uninstaller - Pre-uninstall"

LAUNCHDAEMON_PLIST="/Library/LaunchDaemons/com.aikidosecurity.safechainultimate.plist"

# Stop and unload the daemon
if launchctl list | grep -q "com.aikidosecurity.safechainultimate"; then
    echo "Stopping SafeChain Ultimate daemon..."
    launchctl bootout system/com.aikidosecurity.safechainultimate 2>/dev/null || {
        # Fallback to launchctl unload (old way of stopping the daemon on older macOS versions)
        echo "Trying alternative unload method..."
        launchctl unload "$LAUNCHDAEMON_PLIST" 2>/dev/null || true
    }
fi

# Remove LaunchDaemon plist
if [ -f "$LAUNCHDAEMON_PLIST" ]; then
    echo "Removing LaunchDaemon configuration..."
    rm -f "$LAUNCHDAEMON_PLIST"
fi

echo "Running SafeChain Ultimate teardown..."
sudo "/Library/Application Support/AikidoSecurity/SafeChainUltimate/AikidoSecurity.app/Contents/MacOS/safechain-ultimate" --teardown

echo "Pre-uninstall completed"

exit 0
